# Импорты


```python
import pickle

import catboost as cb
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.naive_bayes import GaussianNB
import matplotlib.pyplot as plt
%matplotlib inline

from malware_ml.prepare_data import df_to_pool
from malware_ml.visualization import plot_roc_curve
from malware_ml.model import load_model, apply_model_to_json
```

# Загрузка и разделение данных

Запускаем первый раз, дальше используем подготовленные части датасета.


```python
path_to_data = '../data/tek_data.csv'
data = pd.read_csv(path_to_data)
print(data.shape[0])
```


```python
seed = 2019
hold_part = 0.02
val_part = 0.3

train_val_data, hold_data = train_test_split(data, test_size=hold_part, random_state=seed)
train_data, val_data = train_test_split(train_val_data, test_size=val_part, random_state=seed)

print(train_data.shape[0], val_data.shape[0], hold_data.shape[0])

train_data.to_csv('../data/train_data.csv', index=False)
val_data.to_csv('../data/val_data.csv', index=False)
hold_data.to_csv('../data/hold_data.csv', index=False)
```


```python
train_data = pd.read_csv('../data/train_data.csv')
val_data = pd.read_csv('../data/val_data.csv')

print(train_data.shape[0], val_data.shape[0])
```


```python
train_data.head()
```

# Простая модель

## Обучение


```python
simple_model = GaussianNB()
```


```python
%%time
columns = train_data.columns
simple_model.fit(train_data[columns[:-1]], train_data[columns[-1]])
```

## Качество


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=simple_model.predict_proba(val_data[columns[:-1]])[:,1],
               name='ROC-кривая на валидационном датасете')
```

## Сохранение и загрузка модели


```python
simple_model_path = '../models/simple_model.pkl'
pickle.dump(simple_model, open(simple_model_path, 'wb'))
```


```python
simple_model = pickle.load(open(simple_model_path, 'rb'))
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=simple_model.predict_proba(val_data[columns[:-1]])[:,1],
               name='ROC-кривая на валидационном датасете')
```

# Catboost

## Обучение


```python
model = cb.CatBoostClassifier(iterations=100)
train_pool = df_to_pool(train_data)
val_pool = df_to_pool(val_data)
```


```python
%%time
model.fit(train_pool, eval_set=val_pool, verbose=True)
```

## Анализ модели


```python
feature_importance = model.get_feature_importance()
features = model.feature_names_

for feature_id in feature_importance.argsort()[::-1]:
    name = features[feature_id]
    importance = feature_importance[feature_id]
    print(f'{name:30}\t\t{importance}')
```

## Качество


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_pool.get_label(),
               pred=model.predict_proba(val_pool)[:,1],
               name='ROC-кривая на валидационном датасете')
```

## Сохранение и загрузка модели


```python
model_path = '../models/model.cb'
model.save_model(model_path)
```


```python
restored_model = load_model(model_path)
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_pool.get_label(),
               pred=restored_model.predict_proba(val_pool)[:,1],
               name='ROC-кривая на валидационном датасете')
```


```python

```


```python

```
