```python
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import pickle
from scipy import stats
from sklearn.model_selection import train_test_split, RandomizedSearchCV, StratifiedKFold
from sklearn.metrics import accuracy_score
from malware_ml import transformators
from malware_ml import visualization
from xgboost import XGBClassifier
from xgboost import plot_importance
from sklearn.linear_model import SGDClassifier
from scipy.sparse import csr_matrix, hstack, save_npz

```


```python
dtypes = {
        'MachineIdentifier':                                    'category',
        'ProductName':                                          'category',
        'EngineVersion':                                        'category',
        'AppVersion':                                           'category',
        'AvSigVersion':                                         'category',
        'IsBeta':                                               'int8',
        'RtpStateBitfield':                                     'float16',
        'IsSxsPassiveMode':                                     'int8',
        'DefaultBrowsersIdentifier':                            'float32',
        'AVProductStatesIdentifier':                            'float32',
        'AVProductsInstalled':                                  'float16',
        'AVProductsEnabled':                                    'float16',
        'HasTpm':                                               'int8',
        'CountryIdentifier':                                    'int16',
        'CityIdentifier':                                       'float32',
        'OrganizationIdentifier':                               'float16',
        'GeoNameIdentifier':                                    'float16',
        'LocaleEnglishNameIdentifier':                          'int16',
        'Platform':                                             'category',
        'Processor':                                            'category',
        'OsVer':                                                'category',
        'OsBuild':                                              'int16',
        'OsSuite':                                              'int16',
        'OsPlatformSubRelease':                                 'category',
        'OsBuildLab':                                           'category',
        'SkuEdition':                                           'category',
        'IsProtected':                                          'float16',
        'AutoSampleOptIn':                                      'int8',
        'PuaMode':                                              'category',
        'SMode':                                                'float16',
        'IeVerIdentifier':                                      'float16',
        'SmartScreen':                                          'category',
        'Firewall':                                             'float16',
        'UacLuaenable':                                         'float64', 
        'Census_MDC2FormFactor':                                'category',
        'Census_DeviceFamily':                                  'category',
        'Census_OEMNameIdentifier':                             'float32', 
        'Census_OEMModelIdentifier':                            'float32',
        'Census_ProcessorCoreCount':                            'float16',
        'Census_ProcessorManufacturerIdentifier':               'float16',
        'Census_ProcessorModelIdentifier':                      'float32', 
        'Census_ProcessorClass':                                'category',
        'Census_PrimaryDiskTotalCapacity':                      'float64', 
        'Census_PrimaryDiskTypeName':                           'category',
        'Census_SystemVolumeTotalCapacity':                     'float64', 
        'Census_HasOpticalDiskDrive':                           'int8',
        'Census_TotalPhysicalRAM':                              'float32',
        'Census_ChassisTypeName':                               'category',
        'Census_InternalPrimaryDiagonalDisplaySizeInInches':    'float32', 
        'Census_InternalPrimaryDisplayResolutionHorizontal':    'float32',
        'Census_InternalPrimaryDisplayResolutionVertical':      'float32', 
        'Census_PowerPlatformRoleName':                         'category',
        'Census_InternalBatteryType':                           'category',
        'Census_InternalBatteryNumberOfCharges':                'float64', 
        'Census_OSVersion':                                     'category',
        'Census_OSArchitecture':                                'category',
        'Census_OSBranch':                                      'category',
        'Census_OSBuildNumber':                                 'int16',
        'Census_OSBuildRevision':                               'int32',
        'Census_OSEdition':                                     'category',
        'Census_OSSkuName':                                     'category',
        'Census_OSInstallTypeName':                             'category',
        'Census_OSInstallLanguageIdentifier':                   'float16',
        'Census_OSUILocaleIdentifier':                          'int16',
        'Census_OSWUAutoUpdateOptionsName':                     'category',
        'Census_IsPortableOperatingSystem':                     'int8',
        'Census_GenuineStateName':                              'category',
        'Census_ActivationChannel':                             'category',
        'Census_IsFlightingInternal':                           'float16',
        'Census_IsFlightsDisabled':                             'float16',
        'Census_FlightRing':                                    'category',
        'Census_ThresholdOptIn':                                'float16',
        'Census_FirmwareManufacturerIdentifier':                'float16',
        'Census_FirmwareVersionIdentifier':                     'float32',
        'Census_IsSecureBootEnabled':                           'int8',
        'Census_IsWIMBootEnabled':                              'float16',
        'Census_IsVirtualDevice':                               'float16',
        'Census_IsTouchEnabled':                                'int8',
        'Census_IsPenCapable':                                  'int8',
        'Census_IsAlwaysOnAlwaysConnectedCapable':              'float16',
        'Wdft_IsGamer':                                         'float16',
        'Wdft_RegionIdentifier':                                'float16',
        'HasDetections':                                        'int8' }

```


```python
df = pd.read_csv('../data/train.csv',dtype = dtypes, nrows = 1000000)
```


```python
path = '../models/data_transformer_pipl.pkl'
data_transformer = pickle.load(open(path, 'rb')) 
```

**Подготавливаем данные**


```python
X = data_transformer.transform(df)
```


```python
y = csr_matrix(df['HasDetections']).transpose()
data  = hstack([X,y], format = 'csr')
```


```python
seed = 42
hold_part = 0.02
val_part = 0.2
train_data, hold_data = train_test_split(data, test_size=hold_part, random_state=seed)
train_data, val_data = train_test_split(train_data, test_size=val_part, random_state=seed)

```


```python
save_npz('../data/train_data.npz', train_data)
save_npz('../data/val_data.npz', val_data)
save_npz('../data/hold_data.npz', hold_data)
```


```python
X_train = train_data[:, :-1]
y_train = train_data[:, -1]
y_train = y_train.toarray().reshape(y_train.shape[0])
```

**Устанавливаем  параметры для нашего классификатора**


```python
clf_xgb = XGBClassifier(learning_rate=0.1,max_depth = 5, n_estimators=300,verbosity=0
                        ,n_jobs=4, objective='binary:logistic', missing=-1)
```

**Для лучшей настройки параметров  можно обучить классификатор с помощью RandomizedSearchCV или GridSearchCV, но мы этого делать не будем т.к. обучение займет  слишком много времени.**


```python
n_folds = 3
param_comb = 4
skf = StratifiedKFold(n_splits=n_folds, shuffle = True, random_state = seed)
param_1 = {'n_estimators': np.random.randint(100, 500),
              'subsample': np.random.uniform(0.3, 0.7),
              'max_depth': [3, 4, 5, 6, 7, 8, 9],
              'colsample_bytree': np.random.uniform(0.5, 0.45),
              'min_child_weight': [1, 2, 3]
             }

params = {'n_estimators': [100, 200, 300, 500],
        'min_child_weight': [1, 5, 10],
        'gamma': [0, 0.5, 1, 2],
        'subsample': [0.3, 0.6, 0.7, 1.0],
        'colsample_bytree': [0.6, 0.8, 1.0],
        'max_depth': [3, 5, 6, 9]
        }
random_search = RandomizedSearchCV(clf_xgb, param_distributions=params, 
                                   n_iter=param_comb, scoring='roc_auc', 
                                   n_jobs=4, cv=skf.split(X,y), 
                                   verbose=3, 
                                   random_state=seed)


```

**Запускаем обучение**


```python
clf_xgb.fit(X_train,y_train)
```

**Оцениваем качество класификатора**


```python
plt.figure(figsize=(10,10))
visualization.plot_roc_curve(true=val_data[:,-1].toarray(),
               pred=clf_xgb.predict_proba(val_data[:,:-1])[:,1],
               name='ROC-кривая на валидационном датасете')

```


```python
fig, ax = plt.subplots(1,1,figsize=(10,10))
plot_importance(clf_xgb, max_num_features=40, ax= ax)
```


```python
path = '../models/xgb_classifer'
clf_xgb.save_model(path)
```

**Простой линейный класификатор  обучающийся с помощью метода стохастического градиентного спуска.**


```python
clf_sgd = SGDClassifier(loss = 'log', penalty = 'l1', random_state = seed)
```


```python
clf_sgd.fit(X_train[:100000,:],y_train[:100000])
```


```python
plt.figure(figsize=(10,10))
visualization.plot_roc_curve(true=val_data[:,-1].toarray(),
               pred=clf_sgd.predict_proba(val_data[:,:-1])[:,1],
               name='ROC-кривая на валидационном датасете')

```


```python
path_simple_clf = '../models/simp_clf.pkl'
pickle.dump(clf_sgd, open(path,'wb'))
```


```python

```
